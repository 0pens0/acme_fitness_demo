version: '3'

services: 
    user-db:
      image: gcr.io/vmwarecloudadvocacy/acmeshop-user-db:latest
      hostname: user-db
      environment:
        - MONGO_INITDB_ROOT_USERNAME=mongoadmin 
        - MONGO_INITDB_ROOT_PASSWORD=secret
        - MONGO_INITDB_DATABASE=acmefit
      cap_add:
        - CHOWN
        - SETGID
        - SETUID
      tmpfs:
        - /tmp:rw,noexec,nosuid
    order-db:
      image: mongo:4
      hostname: order-db
      environment:
        - MONGO_INITDB_ROOT_USERNAME=mongoadmin
        - MONGO_INITDB_ROOT_PASSWORD=secret
      cap_add:
        - CHOWN
        - SETGID
        - SETUID
      tmpfs:
        - /tmp:rw,noexec,nosuid
    catalog-db:
       image: gcr.io/vmwarecloudadvocacy/acmeshop-catalog-db:latest
       hostname: catalog-db
       environment:
        - MONGO_INITDB_ROOT_USERNAME=mongoadmin
        - MONGO_INITDB_ROOT_PASSWORD=secret
        - MONGO_INITDB_DATABASE=acmefit
       cap_add:
        - CHOWN
        - SETGID
        - SETUID
    front-end:
       image: gcr.io/vmwarecloudadvocacy/acmeshop-front-end:1.1.0-beta
       hostname: front-end
       restart: always
       ports:
          - '3000:3000'
       cap_add:
           - NET_BIND_SERVICE
       environment:
           - PORT=3000
           - USERS_HOST=user
           - CATALOG_HOST=catalog
           - CART_HOST=cart   
           - ORDER_HOST=order
           - USERS_PORT=8081
           - CATALOG_PORT=8082
           - CART_PORT=5000
           - ORDER_PORT=6000
           - TRACER_IP=jaeger
           - TRACER_PORT=14268
       depends_on:
           - jaeger
    user:
       image: gcr.io/vmwarecloudadvocacy/acmeshop-user:1.1.0-beta
       hostname: users
       restart: always
       cap_add:
           - NET_BIND_SERVICE
       environment:
           - USERS_DB_USERNAME=mongoadmin
           - USERS_DB_PASSWORD=secret
           - USERS_DB_HOST=user-db
           - USERS_DB_PORT=27017
           - USERS_PORT=8081
           - TRACER_IP=192.168.152.218
           - TRACER_PORT=14268
       depends_on:
           - user-db
           - jaeger
    catalog:
        image: gcr.io/vmwarecloudadvocacy/acmeshop-catalog:1.1.0-beta
        hostname: catalog
        restart: always
        cap_add:
          - NET_BIND_SERVICE
        environment:
             - CATALOG_DB_USERNAME=mongoadmin
             - CATALOG_DB_PASSWORD=secret
             - CATALOG_DB_HOST=catalog-db
             - CATALOG_PORT=8082
             - CATALOG_DB_PORT=27017
             - TRACER_IP=jaeger
             - TRACER_PORT=14268
        depends_on:
             - catalog-db
             - jaeger
    redis-db:
      image: redis:5.0.3-alpine
      hostname: redis-db
      restart: always
      ports:
        - '6379:6379'
    cart:
      image: gcr.io/vmwarecloudadvocacy/acmeshop-cart:1.1.0-beta
      hostname: cart
      restart: always
      environment:
          - REDIS_HOST=redis-db
          - REDIS_PORT=6379
          - CART_PORT=5000
          - JAEGER_HOST=jaeger
          - JAEGER_PORT=6831
      ports:
          - '5000:5000'
      depends_on:
          - redis-db
          - jaeger
    order:
      image: gcr.io/vmwarecloudadvocacy/acmeshop-order:beta
      hostname: order
      restart: always
      ports:
        - '6000:6000'
      environment:
          - PAYMENT_HOST=payment
          - ORDER_PORT=6000
          - ORDER_DB_HOST=order-db
          - ORDER_DB_PASSWORD=secret
          - ORDER_DB_USERNAME=mongoadmin
      depends_on:
          - payment
          - order-db
          - jaeger
    payment:
      image: gcr.io/vmwarecloudadvocacy/acmeshop-payment:latest
      hostname: payment
      restart: always 
    jaeger: 
      image: jaegertracing/all-in-one:1.11
      hostname: jaeger
      restart: always
      ports:
        - '14268:14268'
        - '16686:16686'
        - '5778:5778'
        - '6831-6832:6831-6832/udp'
        - '5775:5775/udp'

